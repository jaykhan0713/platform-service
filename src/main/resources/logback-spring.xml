<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="false">

    <!-- MDC key Spring properties -->
    <springProperty name="MDC_USER_ID" source="app.logging.mdc.userId"/>
    <springProperty name="MDC_REQUEST_ID" source="app.logging.mdc.requestId"/>
    <springProperty name="MDC_KIND" source="app.logging.mdc.kind"/>
    <springProperty name="MDC_NAME" source="app.logging.mdc.name"/>
    <springProperty name="MDC_METHOD" source="app.logging.mdc.method"/>
    <springProperty name="MDC_STATUS" source="app.logging.mdc.status"/>
    <springProperty name="MDC_DURATION_MS" source="app.logging.mdc.durationMs"/>

    <!-- index friendly pattern for lookups -->
    <property name="SIMPLE_PATTERN"
              value='[%thread] logger="%logger{36}" level="%-5level" date="%d{yyyy-MM-dd HH:mm:ss.SSS}" msg="%msg"%n'/>

    <property name="APP_PATTERN"
              value='[%thread] logger="%logger{36}" level="%level" date="%d{yyyy-MM-dd HH:mm:ss.SSS}" traceId="%X{traceId}" spanId="%X{spanId}" msg="%msg"%n'/>
    Changes:

    <property name="MDC_FILTER_PATTERN"
              value='[%thread] logger="%logger{36}" level="%level" date="%d{yyyy-MM-dd HH:mm:ss.SSS}" traceId="%X{traceId}" spanId="%X{spanId}" userId="%X{${MDC_USER_ID}}" requestId="%X{${MDC_REQUEST_ID}}" kind="%X{${MDC_KIND}}" name="%X{${MDC_NAME}}" method="%X{${MDC_METHOD}}" status="%X{${MDC_STATUS}}" durationMs="%X{${MDC_DURATION_MS}}"%n'/>

    <!-- ================= DEV PROFILE ================= -->
    <springProfile name="dev,smoke"> <!-- for helping with seeing logs in smoke tests -->

        <!-- Library/Framework logs -->
        <appender name="DEV_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>${SIMPLE_PATTERN}</pattern>
            </encoder>
        </appender>

        <appender name="DEV_APP_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>${APP_PATTERN}</pattern>
            </encoder>
        </appender>

        <!-- mdc filter logs (one per identity) -->
        <appender name="DEV_MDC_FILTER_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>${MDC_FILTER_PATTERN}</pattern>
            </encoder>
        </appender>

        <root level="INFO">
            <appender-ref ref="DEV_CONSOLE"/>
        </root>

        <!-- Classes in com.jay.template.* Non-identity-based logs -->
        <logger name="com.jay.template.Starter" level="INFO" additivity="false">
            <appender-ref ref="DEV_CONSOLE"/>
        </logger>

        <!-- All classes under com.jay.template.* logs with MDC traceId and userId etc. -->
        <logger name="com.jay.template" level="DEBUG" additivity="false">
            <appender-ref ref="DEV_APP_CONSOLE"/>
        </logger>

        <!-- MDC filter logger with response info as well -->
        <property name="MDC_FILTER_APPENDER" value="DEV_MDC_FILTER_CONSOLE" />

    </springProfile>

    <!-- ================= PROD PROFILE ================= -->
    <springProfile name="prod">

        <!-- JSON console appender for CloudWatch -->
        <appender name="JSON_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder">
                <layout class="ch.qos.logback.contrib.json.classic.JsonLayout">
                    <!-- Use Jackson to build JSON -->
                    <jsonFormatter class="ch.qos.logback.contrib.jackson.JacksonJsonFormatter" />
                    <includeMdc>true</includeMdc>
                    <includeContextName>false</includeContextName>
                    <includeThreadName>true</includeThreadName>
                    <includeLoggerName>true</includeLoggerName>
                    <includeLevel>true</includeLevel>
                    <includeMessage>true</includeMessage>
                    <includeException>true</includeException>

                    <!-- timstamp -->
                    <includeTimestamp>true</includeTimestamp>
                    <timestampFormat>yyyy-MM-dd'T'HH:mm:ss.SSSXXX</timestampFormat>
                    <timestampTimeZone>UTC</timestampTimeZone>
                </layout>
            </encoder>
        </appender>

        <root level="INFO">
            <appender-ref ref="JSON_CONSOLE"/>
        </root>

        <property name="MDC_FILTER_APPENDER" value="JSON_CONSOLE" />

    </springProfile>

    <!-- custom loggers -->
    <logger name="com.jay.template.web.servlet.filter.MdcFilter" level="INFO" additivity="false">
        <appender-ref ref="${MDC_FILTER_APPENDER}" />
    </logger>

</configuration>